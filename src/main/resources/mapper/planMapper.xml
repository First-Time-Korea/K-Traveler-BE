<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.firskorea.plan.mapper.PlanMapper">
	
	<resultMap type="planInfoDto" id="planInfo">
		<result column="id" property="id"/>
		<result column="title" property="title"/>
		<result column="start_date" property="startDate"/>
		<result column="end_date" property="endDate"/>
		<association property="file" resultMap="file" />
	</resultMap>
	
	<resultMap type="planFileDto" id="file">
		<result column="save_folder" property="saveFolder"/>
		<result column="origin_file" property="originFile"/>
		<result column="save_file" property="saveFile"/>
	</resultMap>

	<select id="getRegionList" resultType="regionDto">
		select g.sido_code,
		g.gugun_code, s.sido_name, g.gugun_name,
		s.sido_description,
		s.sido_image
		from gugun g
		join sido s
		on s.sido_code = g.sido_code
		order
		by g.sido_code, g.gugun_code;
	</select>

	<insert id="insertPlan" parameterType="map"
		useGeneratedKeys="true" keyColumn="id" keyProperty="id">
		insert into plan
		(member_id, title)
		values (#{memberId},#{title});
	</insert>

	<insert id="insertPlanAndAttraction" parameterType="map">
		insert into plan_and_attraction (plan_id, content_id, date)
		values (#{planId},#{contentId},#{date});
	</insert>

	<insert id="insertPlanFile" parameterType="PlanFileDto">
		insert into plan_file
		(save_folder, origin_file, save_file, plan_id)
		values
		(#{saveFolder},#{originFile},#{saveFile},#{planId});
	</insert>
	
	<!-- 나의 여행 계획 리스트 조회하기 -->
	<select id="getPlanInfos" parameterType="map" resultMap="planInfo">
		select p.id, p.title, a.start_date, a.end_date, f.save_folder, f.origin_file, f.save_file
		from (
			select id, title
			from plan
			where member_id = #{memberId}
		) p, (
			select plan_id, MIN(date) start_date, MAX(date) end_date
			from plan_and_attraction
			group by plan_id
		) a, plan_file f
		where p.id = f.plan_id
		and p.id = f.plan_id
		order by p.id desc
		limit #{start}, #{listsize}
	</select>
	
	<!-- 나의 여행 계획 총 개수 구하기 -->
	<select id="getTotalPlanCount" parameterType="string" resultType="int">
		select count(id)
		from plan
		where member_id = #{memberId}
	</select>

</mapper>